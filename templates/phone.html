<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AIäºˆç´„é›»è©±ãƒ†ã‚¹ãƒˆ (Cloud TTSç‰ˆ)</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; text-align: center; padding: 20px; background: #f0f2f5; height: 100vh; display: flex; flex-direction: column; align-items: center; }
        #status { font-size: 1.2rem; margin-bottom: 20px; color: #666; height: 1.5em; }
        .phone-btn {
            width: 200px; height: 200px; border-radius: 50%; border: none;
            font-size: 1.5rem; color: white; background: #34c759;
            box-shadow: 0 10px 25px rgba(52, 199, 89, 0.4); cursor: pointer;
            display: flex; align-items: center; justify-content: center; flex-direction: column;
            transition: all 0.3s ease;
        }
        .phone-btn.active { background: #ff3b30; box-shadow: 0 10px 25px rgba(255, 59, 48, 0.4); }
        .phone-btn i { font-size: 3rem; margin-bottom: 10px; font-style: normal; }
        #log { 
            width: 100%; max-width: 600px; margin-top: 30px; 
            background: white; border-radius: 15px; padding: 15px;
            height: 300px; overflow-y: auto; text-align: left;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }
        .msg { margin-bottom: 8px; padding: 8px 12px; border-radius: 12px; max-width: 85%; }
        .msg.user { background: #e9ecef; margin-left: auto; color: #333; }
        .msg.ai { background: #007bff; color: white; margin-right: auto; }

        .controls { margin-top: 20px; font-size: 0.9rem; color: #666; }
    </style>
</head>
<body>
    <h2>ğŸ“ AIäºˆç´„ãƒ†ã‚¹ãƒˆ (æœ¬ç•ªéŸ³å£°)</h2>
    <div id="status">é–‹å§‹ãƒœã‚¿ãƒ³ã‚’ã‚¿ãƒƒãƒ—</div>

    <button id="callBtn" class="phone-btn" onclick="toggleCall()">
        <span id="btnIcon">ğŸ“</span>
        <span id="btnText">é€šè©±é–‹å§‹</span>
    </button>

    <div class="controls">
        â€»Cloud TTSã‚’ä½¿ç”¨ä¸­ï¼ˆã‚¤ãƒ¤ãƒ›ãƒ³æ¨å¥¨ï¼‰
    </div>

    <div id="log"></div>

    <script>
        let ws;
        let recognition;
        let isCallActive = false;
        let currentAudio = null; // å†ç”Ÿä¸­ã®ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
        let isAiSpeaking = false;

        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SpeechRecognition) alert("Chromeãƒ–ãƒ©ã‚¦ã‚¶ã‚’ã”åˆ©ç”¨ãã ã•ã„");

        recognition = new SpeechRecognition();
        recognition.lang = 'ja-JP';
        recognition.continuous = true;
        recognition.interimResults = true;

        function toggleCall() {
            if (!isCallActive) startCall();
            else endCall();
        }

        function startCall() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            ws = new WebSocket(`${protocol}//${window.location.host}/ws`);

            ws.onopen = () => {
                isCallActive = true;
                updateUI(true);
                try { recognition.start(); } catch(e) {}
                document.getElementById('status').innerText = "é€šè©±ä¸­";
            };

            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);

                if (data.type === "audio") {
                    addLog("AI", data.text);
                    playCloudAudio(data.audio);
                } else if (data.type === "error") {
                    addLog("System", "Error: " + data.text);
                }
            };

            ws.onclose = () => endCall();
        }

        function endCall() {
            isCallActive = false;
            updateUI(false);
            if(ws) ws.close();
            try { recognition.stop(); } catch(e){}
            stopAudio();
            document.getElementById('status').innerText = "é€šè©±çµ‚äº†";
        }

        // Base64ã®MP3ã‚’å†ç”Ÿ
        function playCloudAudio(base64Data) {
            stopAudio(); // å‰ã®ãŒã‚ã‚Œã°æ­¢ã‚ã‚‹
            isAiSpeaking = true;

            const audioSource = "data:audio/mp3;base64," + base64Data;
            currentAudio = new Audio(audioSource);

            currentAudio.onended = () => {
                isAiSpeaking = false;
            };

            currentAudio.play().catch(e => console.log("å†ç”Ÿã‚¨ãƒ©ãƒ¼(ã‚¿ãƒƒãƒ—ãŒå¿…è¦ã‹ã‚‚):", e));
        }

        // å†ç”Ÿåœæ­¢ï¼ˆå‰²ã‚Šè¾¼ã¿ç”¨ï¼‰
        function stopAudio() {
            if (currentAudio) {
                currentAudio.pause();
                currentAudio.currentTime = 0;
                currentAudio = null;
            }
            isAiSpeaking = false;
        }

        recognition.onresult = (event) => {
            const results = Array.from(event.results);
            const lastResult = results[results.length - 1];
            const transcript = lastResult[0].transcript;

            // â˜…å‰²ã‚Šè¾¼ã¿åˆ¤å®šï¼ˆæœ¬ç•ªéŸ³å£°ç‰ˆï¼‰
            if (isAiSpeaking && transcript.length > 2) {
                console.log("å‰²ã‚Šè¾¼ã¿æ¤œçŸ¥: " + transcript);
                stopAudio(); // éŸ³å£°ã‚’å³åœæ­¢
                ws.send(JSON.stringify({ event: "interrupt" }));
                isAiSpeaking = false; // ãƒ•ãƒ©ã‚°ã‚’ä¸‹ã‚ã™
            }

            if (lastResult.isFinal) {
                if (transcript.trim().length > 0) {
                    addLog("ã‚ãªãŸ", transcript);
                    ws.send(JSON.stringify({ text: transcript }));
                }
            }
        };

        function updateUI(active) {
            const btn = document.getElementById('callBtn');
            const icon = document.getElementById('btnIcon');
            const text = document.getElementById('btnText');
            if (active) {
                btn.classList.add('active');
                icon.innerText = "ğŸ“´";
                text.innerText = "åˆ‡æ–­";
            } else {
                btn.classList.remove('active');
                icon.innerText = "ğŸ“";
                text.innerText = "é€šè©±é–‹å§‹";
            }
        }

        function addLog(role, text) {
            const log = document.getElementById('log');
            const div = document.createElement('div');
            div.className = `msg ${role === 'AI' ? 'ai' : 'user'}`;
            if(role === 'System') div.style.color = 'red';
            div.innerText = text;
            log.appendChild(div);
            log.scrollTop = log.scrollHeight;
        }
    </script>
</body>
</html>